<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/cliente.css">
    <title>Cliente | DuVale</title>
</head>
<body>


<!-- CARD INICIAL -->    
<div class="container">
    <img src="./img/duvalep.png" alt="Logo Duvale" class="logo">
    <p id="user-name">Usu√°rio</p>
    <a href="#" onclick="logout()" class="logout-btn">Sair</a> <!-- ‚úÖ Bot√£o de logout -->
    <div class="card checkout">
        <div class="details">
            <span><strong>Mensalidade:</strong><span id="mes-referencia">Mar/2025</span></span>
            <span><strong>Subtotal:</strong> <span id="valor"><sup>R$</sup> 450,00</span></span>
            <span><strong>Desconto:</strong> <span>R$ 0,00</span></span>
            <span><strong>Juros/multas:</strong> <span>R$ 0,00</span></span>
        </div>
        <div class="checkout--footer" onclick="gerarQRCode()">
            <span class="tooltip">Clique para gerar o QR Code PIX</span>
            <label id="valor" class="price"><sup>R$</sup> 1,00</label>
            <button class="checkout-btn" type="button" id="gerar-pix">
                <img src="https://upload.wikimedia.org/wikipedia/commons/a/a2/Logo‚Äîpix_powered_by_Banco_Central_%28Brazil%2C_2020%29.svg" alt="Pix">
            </button>
        </div>
        <p id="resultado" class="mensagem-status" style="text-align: center;"></p>
        <div id="qrcode-container" style="display: none; text-align: center;">
            <img id="qrcode" src="" alt="QR Code PIX" class="qr-code" style="display: none;">
            <div class="progress" style="margin-top: 15px; height: 20px; display: none;">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
            </div>          
            <textarea id="codigo-pix" rows="3" readonly></textarea>
            <button onclick="copiarCodigoPix()" id="botao-copiar" class="botao-copiar">üìã Copiar C√≥digo PIX</button>
        </div>
    </div>
</div>
<!--rodape da pagina-->
    <p>
        <hr class="footer-hr">
        <footer class="footerr">
        Setta Software Solutions. Todos os direitos reservados | Desenvolvido por Fernando Freitas ¬© 2024 
        | <a href="https://wa.me/5588981202539" target="_blank" rel="noopener noreferrer">Suporte</a>
    </p>
</footer>
<script src="js/administrativo/clientes.js"></script>
<script>
    /**
     * ‚úÖ Fun√ß√£o para buscar o valor da mensalidade no backend e exibir no frontend
     */
    async function carregarMensalidade() {
        try {
            const response = await fetch(`${apiBaseUrl}/api/mensalidade`);
            if (!response.ok) throw new Error("Erro ao obter valor da mensalidade.");

            const data = await response.json();
            document.getElementById("valor").innerHTML = `<sup>R$</sup> ${data.valor.toFixed(2)}`;

        } catch (error) {
            console.error("‚ùå Erro ao carregar valor da mensalidade:", error);
            document.getElementById("valor").innerHTML = `<sup>R$</sup> 450.00`; // Valor padr√£o
        }
    }

    // ‚úÖ Chama a fun√ß√£o ao carregar a p√°gina
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            await carregarUsuario();
            await carregarMensalidade();
        } catch (error) {
            console.error("Erro na inicializa√ß√£o:", error);
        }
    });

    //#############################################################################
    // ‚úÖ Fun√ß√£o para GERAR QR CODE MERCADO PAGO
    //#############################################################################

    /**
     * Gera um QR Code PIX usando a API do Mercado Pago.
     * 
     * - Obt√©m o valor da mensalidade do elemento HTML.
     * - Envia uma requisi√ß√£o `POST` para `/gerar-qrcode` no backend.
     * - Exibe o QR Code gerado e o c√≥digo PIX no frontend.
     */
    async function gerarQRCode() {
        console.log("Fun√ß√£o gerarQRCode() foi chamada!");

        // üîç Obt√©m o valor da mensalidade na interface
        const valorLabel = document.getElementById('valor');
        const valor = parseFloat(valorLabel.textContent.replace("R$", "").replace(",", ".").trim());

        // üö® Verifica se o valor √© v√°lido
        if (isNaN(valor) || valor <= 0) {
            document.getElementById('resultado').innerHTML = "‚ùå Informe um valor v√°lido!";
            return;
        }

        try {
            // üì° Faz a requisi√ß√£o ao backend para gerar o QR Code
            const response = await fetch(`${apiBaseUrl}/gerar-qrcode`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem("authToken")}` },
                body: JSON.stringify({ valor: valor, descricao: "Mensalidade Aluguel" })
            });

            // üö® Verifica se a resposta do servidor √© v√°lida
            if (!response.ok) {
                throw new Error(`Erro no servidor (${response.status})`);
            }

            const data = await response.json();
            console.log("Resposta do servidor:", data);

            // üö® Garante que os dados necess√°rios foram retornados
            if (!data || !data.qr_code || !data.qr_data || !data.payment_id) {
                document.getElementById('resultado').innerText = "‚ùå Erro ao gerar QR Code.";
                return;
            }

            // ‚úÖ Exibe o QR Code gerado
            document.getElementById('qrcode-container').style.display = 'block';
            document.getElementById('qrcode').src = `data:image/png;base64,${data.qr_code}`;
            document.getElementById('qrcode').style.display = 'block';

            // ‚úÖ Exibe c√≥digo PIX e bot√£o de c√≥pia
            const codigoPixElemento = document.getElementById('codigo-pix');
            const botaoCopiar = document.getElementById('botao-copiar');

            codigoPixElemento.value = data.qr_data;
            codigoPixElemento.style.display = 'block';
            botaoCopiar.style.display = 'inline-block';

            // ‚úÖ Define um tempo limite de 3 minutos para o pagamento
            iniciarTemporizador(3, data.payment_id);

        } catch (error) {
            document.getElementById('resultado').innerText = `‚ùå Erro: ${error.message}`;
            console.error("Erro:", error);
        }
    }

    function ocultarElementos() {
        ["qrcode-container", "qrcode", "codigo-pix", "botao-copiar"].forEach(id => {
            const elemento = document.getElementById(id);
            if (elemento) elemento.style.display = 'none';
        });
    }
</script>
</body>
</html>